pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
function _init()
    load_map()
    player = {x = 100, y = 100, dx = 0, dy = 0, score = 0, on_ground = false}
    gravity = 0.2
    jump_strength = -2.5
    move_speed = 1
    bullet_speed = 2
    bullets = {}
    treasures = {{x = 40, y = 40}, {x = 80, y = 24}}
    enemies = {{x = 64, y = 64, dir = 1}}
    exit = {x = 120, y = 120}
    
end

function _update()
    player.dy += gravity
    player.on_ground = false
    
    -- player movement
    if btn(0) then player.dx = -move_speed end -- left
    if btn(1) then player.dx = move_speed end -- right
    if not btn(0) and not btn(1) then player.dx = 0 end -- no horizontal movement

    -- horizontal collision detection
    player.x += player.dx
    if is_wall(player.x, player.y) or is_wall(player.x + 7, player.y) or is_wall(player.x, player.y + 7) or is_wall(player.x + 7, player.y + 7) then
        player.x -= player.dx
    end

    -- vertical collision detection
    player.y += player.dy
    if is_wall(player.x, player.y + 7) or is_wall(player.x + 7, player.y + 7) then
        player.y -= player.dy
        player.dy = 0
        player.on_ground = true
    end

    -- jumping
    if player.on_ground and btnp(5) then -- button 5 is usually the space bar
        player.dy = jump_strength
        player.on_ground = false
    end
    
    -- shooting bullets
    if btnp(4) then -- button 4 is usually the z key
        spawn_bullet(player.x + 4, player.y + 4, 1) 
    end
    
    -- update bullets
    for bullet in all(bullets) do
        bullet.x += bullet.dx
        bullet.y += bullet.dy
        
        -- check for collision with enemies
        for enemy in all(enemies) do
            if abs(bullet.x - enemy.x) < 8 and abs(bullet.y - enemy.y) < 8 then
                -- mark bullet for removal
                bullet.remove = true
                player.score += 50
                break
            end
        end
    end

    -- remove bullets marked for removal
    for i = #bullets, 1, -1 do
        if bullets[i].remove then
            del(bullets, bullets[i])
        end
    end
    
   
    for enemy in all(enemies) do
     
        enemy.x += enemy.dir
        if enemy.x < 8 or enemy.x > 112 then enemy.dir = -enemy.dir end
       
        if abs(player.x - enemy.x) < 8 and abs(player.y - enemy.y) < 8 then
           
            _init() 
        end
    end
    
    -- check if all treasures collected and player reached exit
    if #treasures == 0 and abs(player.x - exit.x) < 8 and abs(player.y - exit.y) < 8 then
        -- level complete (for simplicity, just restart)
        _init()
    end
end



function _draw()
    cls()

   
    draw_map()
   
    spr(1, player.x, player.y)
   
    for t in all(treasures) do
        spr(2, t.x, t.y)
    end
   
    for e in all(enemies) do
        spr(3, e.x, e.y)
    end
    
    for bullet in all(bullets) do
        
        local sprite_attack = 6 + rnd(4) 
        spr(sprite_attack, bullet.x, bullet.y)
    end
end


function load_map()
    map(0, 0, 0, 0, 16, 16)
end

function is_wall(x, y)
    -- check if the tile at (x, y) is a wall
    -- assume walls have sprite index 16 (or whatever index you use for walls)
    local tile_x = flr(x / 8)
    local tile_y = flr(y / 8)
    local tile = mget(tile_x, tile_y)
    return tile == 16
end


function spawn_bullet(x, y, direction)
    local bullet = {
        x = x,
        y = y,
        dx = bullet_speed * direction, -- bullet speed in the specified direction
        dy = 0, -- bullets typically don't move vertically
        remove = false -- initialize the remove flag
    }
    add(bullets, bullet)
end

function draw_map()
    
    map(0, 0, 0, 0, 16, 16)
end


__gfx__
00000000300303030000000000000005ffffff4fffffffff00000000000000000033300000000000000000000000000000000000000000000000000000000000
000000003333333300aa000005a50555333fff44ffffffff00000000003330003330333000000000000000000000000000000000000000000000000000000000
00700700003ff30000aa0aa00a55555544344433ffff6fff00000338093033003300003300000338000000000000000000000000000000000000000000000000
00077000333ff30300aa0a0005555500ff34333fffffffff933033b3a90003303000033b930003b3000000000000000000000000000000000000000000000000
00077000300bb33300aaaa0000555500fff433fffffff6ffa033333300000330300003b8a3300333000000000000000000000000000000000000000000000000
00700700000bb000000aaa0005555550fff43fffffffffff00333000000000333399000000333330000000000000000000000000000000000000000000000000
00000000000bb0000000000055500550ff443fffff6fffff000000000000033b000a000000000000000000000000000000000000000000000000000000000000
0000000000ffff00000000005550000044444444ffffffff00000000000003b80000000000000000000000000000000000000000000000000000000000000000
334344444f43fff40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
334333f4443344440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
33444344433f4ff40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4f33f34433ff4ff40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4f43f334444444440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
633ff4444ffff4f40000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
434444444fff64440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4643fff4444444440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000007774f4ffff4f4777ffffffffffffffff7774f4ffff4f4777000000000000000000000000000000000000000000000000000000000000000000000000
000000007774f4ffff4f4777f66666666666666f7774f4ffff4f4777000000000000000000000000000000000000000000000000000000000000000000000000
000000007774f4ffff4f477764444444444444467774f4ffff4f4777000000000000000000000000000000000000000000000000000000000000000000000000
000000007774f4ffff4f47774a74f4ffff4f47a4aa74f4ffff4f47aa000000000000000000000000000000000000000000000000000000000000000000000000
000000007774f4ffff4f4777a774f4ffff4f477aaffffffffffffffa000000000000000000000000000000000000000000000000000000000000000000000000
000000007774f4ffff4f47777774f4ffff4f4777a44444444444444a000000000000000000000000000000000000000000000000000000000000000000000000
000000007774f4ffff4f47777774f4ffff4f47776666666666666666000000000000000000000000000000000000000000000000000000000000000000000000
000000007774f4ffff4f47777774f4ffff4f4777ffffffffffffffff000000000000000000000000000000000000000000000000000000000000000000000000
__map__
1005050505050505050505050511101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1005050505050505050505050511111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1005050505050505050505050505051010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1005050505050505050505050505051010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1005050505050505050505050505051010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1005050505050505050505050505051000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500
1110101010101010050505050505051000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500
1011111111111111050505050505051000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500
1005050505050505050505050505051000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500
1005050505050505050505050505051000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500
1005050505050505050505050505051000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500
1005050505050505050510101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500
1005050505050505050505434405111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1005050505050505050505414205051000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1005050505050505050505454605051000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1010101010101010101010101010101000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
